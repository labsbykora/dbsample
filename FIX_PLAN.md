# Fix Plan - PostgreSQL Database Sampling Utility

## Overview

This document outlines a prioritized plan for addressing issues and implementing enhancements identified in the project review.

**Target Timeline**: 2-3 weeks for high/medium priority items

---

## Phase 1: Critical Fixes (Week 1)

### 1.1 Update Outdated Documentation ‚ö†Ô∏è **HIGH PRIORITY**

**Issue**: `SCHEMA_AND_STAGING.md` incorrectly states staging is NOT implemented, but it actually IS implemented.

**Files to Update**:
- `SCHEMA_AND_STAGING.md` - Update to reflect staging implementation
- `README.md` - Verify staging information is accurate

**Steps**:
1. Review `SCHEMA_AND_STAGING.md` content
2. Update section "Question 2: Staging Data in Temporary Schema/Database"
3. Change status from "‚ùå NOT implemented" to "‚úÖ Implemented"
4. Update examples and usage instructions
5. Verify README.md mentions staging correctly

**Estimated Time**: 30 minutes

**Acceptance Criteria**:
- [ ] Documentation accurately reflects staging implementation
- [ ] Examples are correct
- [ ] No confusion about staging capabilities

---

### 1.2 Handle Unimplemented CLI Flags ‚ö†Ô∏è **HIGH PRIORITY**

**Issue**: Three CLI flags are accepted but not implemented:
- `--verify`: Referential integrity verification
- `--dry-run`: Full dry-run mode (currently just exits)
- `--self-test`: End-to-end test mode

**Decision Required**: Implement or Remove?

#### Option A: Remove Flags (Recommended for MVP)

**Rationale**: 
- Keeps MVP focused
- Avoids confusion
- Can add back in future release

**Steps**:
1. Remove `--verify` flag from CLI
2. Remove `--self-test` flag from CLI
3. Keep `--dry-run` but improve message
4. Update documentation to remove references
5. Add note in CHANGELOG about removed flags

**Estimated Time**: 1 hour

**Files to Modify**:
- `pg_sample/cli.py` - Remove flag definitions and parameters
- `README.md` - Remove from feature list
- `USAGE_GUIDE.md` - Remove from options list
- Create `CHANGELOG.md` - Document removal

**Acceptance Criteria**:
- [ ] Flags removed from CLI
- [ ] No references in documentation
- [ ] CHANGELOG updated

#### Option B: Implement Flags (Future Enhancement)

**If choosing to implement**, see Phase 3 below.

---

### 1.3 Add IDENTITY Column Support ‚ö†Ô∏è **HIGH PRIORITY**

**Issue**: PostgreSQL 10+ IDENTITY columns aren't detected. Only `nextval()` in defaults is checked.

**Impact**: IDENTITY column sequences won't be set correctly after import.

**Files to Modify**:
- `pg_sample/output.py` - Update `_write_sequence_values()` method
- `pg_sample/schema.py` - Update `_enrich_table()` to detect IDENTITY columns

**Steps**:

1. **Update schema discovery** (`pg_sample/schema.py`):
   ```python
   # In _enrich_table(), add IDENTITY column detection:
   # Query pg_attribute.attidentity to detect IDENTITY columns
   # Store IDENTITY info in column metadata
   ```

2. **Update sequence detection** (`pg_sample/output.py`):
   ```python
   # In _write_sequence_values():
   # 1. Check for IDENTITY columns (not just nextval() defaults)
   # 2. Use pg_get_serial_sequence() to get sequence name
   # 3. Include IDENTITY sequences in setval() calls
   ```

3. **Test with PostgreSQL 10+ database**:
   - Create table with IDENTITY column
   - Verify sequence is detected
   - Verify setval() is generated correctly

**Estimated Time**: 3-4 hours

**Acceptance Criteria**:
- [ ] IDENTITY columns are detected
- [ ] Sequences are found using `pg_get_serial_sequence()`
- [ ] setval() calls are generated for IDENTITY sequences
- [ ] Tested with PostgreSQL 10+ database

**Test Cases**:
- Table with GENERATED ALWAYS AS IDENTITY
- Table with GENERATED BY DEFAULT AS IDENTITY
- Table with both IDENTITY and SERIAL columns
- IDENTITY column with excluded column

---

## Phase 2: Important Improvements (Week 2)

### 2.1 Add Version to Export Header üìù **MEDIUM PRIORITY**

**Issue**: Export header doesn't include tool version.

**Files to Modify**:
- `pg_sample/output.py` - Update `_write_header()` method
- `setup.py` - Ensure version is accessible

**Steps**:
1. Import version from package metadata or setup.py
2. Add version line to header: `-- Generated by pg-sample v1.0.0`
3. Test header output

**Estimated Time**: 30 minutes

**Acceptance Criteria**:
- [ ] Version appears in export header
- [ ] Version matches setup.py version

---

### 2.2 Warn When FK References Table Without PK üìù **MEDIUM PRIORITY**

**Issue**: Foreign key resolution silently skips tables without primary keys.

**Files to Modify**:
- `pg_sample/sampling.py` - Update `_resolve_foreign_keys()` method

**Steps**:
1. Add warning when FK references table without PK
2. Log which FK constraint is affected
3. Document this limitation

**Estimated Time**: 1 hour

**Acceptance Criteria**:
- [ ] Warning logged when FK references table without PK
- [ ] Warning includes FK constraint name
- [ ] Documentation updated

**Example Warning**:
```
WARNING: Foreign key 'orders.customer_fk' references table 'customers' which has no primary key. 
FK resolution will be skipped for this constraint.
```

---

### 2.3 Improve Excluded Sequence Column Handling üìù **MEDIUM PRIORITY**

**Issue**: If a column using a sequence is excluded, sequence won't be set correctly.

**Files to Modify**:
- `pg_sample/output.py` - Update `_write_sequence_values()` method
- `pg_sample/sampling.py` - Track excluded columns

**Steps**:
1. Check if sequence column is excluded
2. If excluded, query source database for max value
3. Use queried max value for setval()
4. Add warning if sequence column is excluded

**Estimated Time**: 2 hours

**Acceptance Criteria**:
- [ ] Excluded sequence columns are detected
- [ ] Max value is queried from source database
- [ ] setval() uses correct value
- [ ] Warning is logged

---

### 2.4 Add Constants for Magic Numbers üìù **LOW PRIORITY**

**Issue**: Hardcoded values (e.g., `50` tables threshold) should be constants.

**Files to Modify**:
- `pg_sample/cli.py` - Add constants

**Steps**:
1. Define constants at module level:
   ```python
   STAGING_THRESHOLD_TABLES = 50
   STAGING_THRESHOLD_FKS = 5
   DEFAULT_ROW_LIMIT = 100
   ```
2. Replace hardcoded values with constants
3. Add comments explaining thresholds

**Estimated Time**: 30 minutes

**Acceptance Criteria**:
- [ ] All magic numbers replaced with named constants
- [ ] Constants are documented
- [ ] Easy to adjust thresholds

---

## Phase 3: Future Enhancements (Backlog)

### 3.1 Implement Basic Dry-Run Mode üîÆ **FUTURE**

**Issue**: `--dry-run` flag exists but only exits without showing what would be sampled.

**Approach**: Two-phase implementation

**Phase 3.1a: Basic Dry-Run (No DB Connection)**
- Show table list from schema discovery
- Show limit rules and which tables they match
- Show estimated row counts (if available from metadata)
- Don't connect to database

**Phase 3.1b: Full Dry-Run (With DB Connection)**
- Connect to database
- Discover schema
- Show actual table counts
- Show which tables would be sampled
- Show estimated output size
- Don't generate output file

**Estimated Time**: 
- Phase 3.1a: 4-6 hours
- Phase 3.1b: 6-8 hours

**Files to Modify**:
- `pg_sample/cli.py` - Implement dry-run logic
- `pg_sample/schema.py` - Add metadata queries for estimates

---

### 3.2 Implement Verify Flag üîÆ **FUTURE**

**Issue**: `--verify` flag exists but not implemented.

**Functionality**:
- After sampling, verify referential integrity
- Check all foreign key constraints
- Report any violations
- Exit with error code if violations found

**Estimated Time**: 6-8 hours

**Files to Modify**:
- `pg_sample/cli.py` - Add verify logic
- `pg_sample/sampling.py` - Add verification methods

---

### 3.3 Implement Self-Test Flag üîÆ **FUTURE**

**Issue**: `--self-test` flag exists but not implemented.

**Functionality**:
- Create temporary database
- Run sampling
- Import sample into temp database
- Verify referential integrity
- Report success/failure
- Cleanup temp database

**Estimated Time**: 8-10 hours

**Files to Modify**:
- `pg_sample/cli.py` - Add self-test logic
- New file: `pg_sample/self_test.py` - Self-test implementation

---

### 3.4 Add Progress Bars üîÆ **FUTURE**

**Issue**: For very large exports, progress bars would be helpful.

**Approach**:
- Use `tqdm` library (optional dependency)
- Show progress for:
  - Table sampling
  - FK resolution
  - Output generation

**Estimated Time**: 3-4 hours

**Files to Modify**:
- `pg_sample/sampling.py` - Add progress bars
- `pg_sample/output.py` - Add progress bars
- `requirements.txt` - Add tqdm as optional

---

### 3.5 Streaming for Very Large Tables üîÆ **FUTURE**

**Issue**: All rows loaded into memory with `fetchall()`.

**Approach**:
- Use `fetchmany()` or server-side cursors
- Stream rows to output
- Process in batches

**Estimated Time**: 6-8 hours

**Files to Modify**:
- `pg_sample/sampling.py` - Change to streaming
- `pg_sample/output.py` - Support streaming writes

---

## Implementation Order

### Week 1: Critical Fixes
1. ‚úÖ Update outdated documentation (30 min)
2. ‚úÖ Handle unimplemented flags (1 hour) - **Decision: Remove or Implement?**
3. ‚úÖ Add IDENTITY column support (3-4 hours)

**Total: ~5-6 hours**

### Week 2: Important Improvements
4. ‚úÖ Add version to export header (30 min)
5. ‚úÖ Warn when FK references table without PK (1 hour)
6. ‚úÖ Improve excluded sequence column handling (2 hours)
7. ‚úÖ Add constants for magic numbers (30 min)

**Total: ~4 hours**

### Backlog: Future Enhancements
8. ‚úÖ Implement basic dry-run mode (4-6 hours) - **COMPLETED**
9. ‚úÖ Implement verify flag (6-8 hours) - **COMPLETED**
10. ‚úÖ Implement self-test flag (8-10 hours) - **COMPLETED**
11. ‚úÖ Add progress bars (3-4 hours) - **COMPLETED**
12. Streaming for very large tables (6-8 hours) - **DEFERRED TO FUTURE VERSION**

---

## Decision Points

### Decision 1: Unimplemented Flags
**Question**: Should we implement or remove `--verify` and `--self-test` flags?

**Recommendation**: **Remove for MVP**, implement in future release

**Rationale**:
- Keeps MVP focused
- Avoids confusion
- Can add back when properly implemented
- `--dry-run` can be improved incrementally

**Alternative**: Implement basic versions now (adds 10-15 hours)

---

### Decision 2: IDENTITY Column Support
**Question**: Is PostgreSQL 10+ support required for MVP?

**Recommendation**: **Yes, implement now**

**Rationale**:
- PostgreSQL 10+ is widely used
- IDENTITY columns are common
- Fix is straightforward (3-4 hours)
- Important for correctness

---

### Decision 3: Testing Strategy
**Question**: Should we add unit tests now or later?

**Recommendation**: **Add basic tests in Phase 2**

**Rationale**:
- Tests are important for maintainability
- Start with critical paths
- Expand over time

---

## Testing Plan

### For Each Fix

1. **Unit Tests** (where applicable):
   - Test the specific functionality
   - Test edge cases
   - Test error conditions

2. **Integration Tests**:
   - Test with real database
   - Test with various scenarios
   - Verify output correctness

3. **Manual Testing**:
   - Test with existing databases
   - Verify backward compatibility
   - Check performance impact

---

## Risk Assessment

### Low Risk
- Documentation updates
- Adding version to header
- Adding constants
- Adding warnings

### Medium Risk
- IDENTITY column support (needs PostgreSQL 10+ testing)
- Excluded sequence column handling (needs edge case testing)
- Removing flags (may break user scripts)

### High Risk
- None identified for Phase 1-2 fixes

---

## Success Criteria

### Phase 1 Complete When:
- [ ] All documentation is accurate
- [ ] Unimplemented flags are handled (removed or implemented)
- [ ] IDENTITY columns are supported
- [ ] All tests pass
- [ ] No regressions introduced

### Phase 2 Complete When:
- [ ] Version appears in export header
- [ ] Warnings for FK without PK
- [ ] Excluded sequence columns handled
- [ ] Constants replace magic numbers
- [ ] All tests pass

---

## Notes

- All fixes should maintain backward compatibility
- Each fix should be tested independently
- Consider creating a feature branch for each fix
- Update CHANGELOG.md for each change
- Update documentation as needed

---

## Estimated Total Time

- **Phase 1**: 5-6 hours
- **Phase 2**: 4 hours
- **Total for MVP fixes**: ~9-10 hours

- **Phase 3 (Future)**: 27-36 hours
- **Grand Total**: ~36-46 hours for all enhancements

